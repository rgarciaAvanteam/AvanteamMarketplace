<!DOCTYPE html>
<html>
<head>
    <title>Authentification...</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f5f5f5;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #0d6efd;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        p {
            color: #333;
        }
        
        #debug-info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 80%;
            max-height: 200px;
            overflow: auto;
        }
    </style>
    <script>
        window.onload = function() {
            // Récupérer les paramètres de l'URL
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const error = urlParams.get('error') || '';  // Assure qu'error n'est jamais null
            const message = urlParams.get('message') || '';
            
            // Déterminer le préfixe du chemin pour faciliter le diagnostic
            // Utiliser une regex pour extraire proprement le préfixe
            let pathPrefix = "";
            const marketplacePattern = /^(.*?)(Custom\/MarketPlace)/i;
            const match = window.location.pathname.match(marketplacePattern);
            if (match && match[1]) {
                pathPrefix = match[1];
            } else {
                pathPrefix = "Préfixe non détecté";
            }
            
            // Ajouter des informations de débogage visibles pour l'utilisateur
            const debugInfo = document.createElement('div');
            debugInfo.id = 'debug-info';
            debugInfo.innerHTML = `
                <strong>URL de callback:</strong> ${window.location.href}<br>
                <strong>Préfixe détecté:</strong> ${pathPrefix}<br>
                <strong>Token:</strong> ${token ? 'Présent' : 'Absent'}<br>
                <strong>Error:</strong> ${error || 'Aucune'}<br>
                <strong>Message:</strong> ${message || 'Aucun'}<br>
            `;
            document.body.appendChild(debugInfo);
            
            console.log("Paramètres reçus:", { token, error, message });
            console.log("URL complète:", window.location.href);
            
            // Traiter le résultat
            if (token) {
                // Sauvegarder le token dans le sessionStorage
                sessionStorage.setItem("marketplaceAuthToken", token);
                
                // Notifier la page parente du succès
                if (window.opener) {
                    window.opener.postMessage({ 
                        type: "AUTH_SUCCESS", 
                        token 
                    }, "*");
                    
                    // Fermer cette fenêtre après 500ms
                    setTimeout(() => window.close(), 500);
                } else {
                    // Rediriger vers la page principale si pas de fenêtre parente
                    window.location.href = "/Custom/MarketPlace/Default.aspx";
                }
            } else if (error) {
                // Notifier la page parente de l'erreur
                if (window.opener) {
                    window.opener.postMessage({ 
                        type: "AUTH_ERROR", 
                        error: error || "unknown_error",
                        message: message || "Échec de l'authentification"
                    }, "*");
                    
                    // Fermer cette fenêtre après 1s
                    setTimeout(() => window.close(), 1000);
                } else {
                    // Afficher l'erreur si pas de fenêtre parente
                    document.body.innerHTML = `
                        <h2>Erreur d'authentification</h2>
                        <p>${message || "Une erreur s'est produite lors de l'authentification."}</p>
                        <button onclick="window.location.href='/Custom/MarketPlace/Default.aspx'">Retour au Marketplace</button>
                    `;
                }
            } else {
                // Aucun paramètre utile trouvé
                // Notifier la page parente de l'erreur avec un champ error explicite
                if (window.opener) {
                    window.opener.postMessage({ 
                        type: "AUTH_ERROR", 
                        error: "missing_parameters",
                        message: "Paramètres d'authentification manquants."
                    }, "*");
                    
                    // Fermer cette fenêtre après 1s
                    setTimeout(() => window.close(), 1000);
                } else {
                    document.body.innerHTML = `
                        <h2>Erreur d'authentification</h2>
                        <p>Paramètres d'authentification manquants.</p>
                        <button onclick="window.location.href='/Custom/MarketPlace/Default.aspx'">Retour au Marketplace</button>
                    `;
                }
            }
        };
    </script>
</head>
<body>
    <div class="spinner"></div>
    <p>Authentification en cours...</p>
</body>
</html>